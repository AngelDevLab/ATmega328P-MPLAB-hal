#include "app.h"
#include "MPU6050.h"
#include "ILI9341.h"
#include <avr/pgmspace.h>

const uint8_t myball3d_image[1568] PROGMEM = {
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF7, 0x9F, 0xDE, 0x7E, 0xCD, 0xBD,
    0xB4, 0xFC, 0xAC, 0x7C, 0xAC, 0x3B, 0xAC, 0x5B, 0xBD, 0x1C, 0xD6, 0x5D,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0x1F,
    0xCD, 0xBD, 0xBD, 0x3D, 0xBD, 0x1C, 0xBD, 0x1C, 0xB4, 0xDC, 0xB4, 0x9B,
    0xAC, 0x5B, 0x9B, 0xDA, 0x93, 0x5A, 0x7A, 0xB9, 0x6A, 0x38, 0xA4, 0x5B,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xDF, 0xD6, 0x1D, 0xCD, 0x9D, 0xCD, 0xBD, 0xCD, 0x9D,
    0xC5, 0x9D, 0xC5, 0x7D, 0xBD, 0x5C, 0xBC, 0xFC, 0xB4, 0xBB, 0xAC, 0x5B,
    0x9B, 0xDA, 0x93, 0x79, 0x7A, 0xD9, 0x62, 0x17, 0x49, 0x76, 0xB5, 0x5C,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF7, 0x7F, 0xCD, 0xDD,
    0xD5, 0xFD, 0xD5, 0xFD, 0xD5, 0xFD, 0xD6, 0x1D, 0xD5, 0xFD, 0xCD, 0xFD,
    0xCD, 0xDD, 0xC5, 0x9C, 0xBD, 0x3C, 0xB4, 0xDB, 0xAC, 0x5B, 0x9B, 0xBA,
    0x8B, 0x39, 0x72, 0xB8, 0x62, 0x17, 0x41, 0x16, 0x7B, 0x59, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xF7, 0x7F, 0xD5, 0xDD, 0xD6, 0x1E, 0xDE, 0x5E, 0xDE, 0x7E,
    0xDE, 0x9E, 0xE6, 0x9E, 0xDE, 0x9E, 0xDE, 0x7E, 0xDE, 0x5D, 0xD6, 0x1D,
    0xCD, 0xBD, 0xC5, 0x5C, 0xB4, 0xBB, 0xA4, 0x3A, 0x93, 0x99, 0x82, 0xF8,
    0x6A, 0x77, 0x59, 0xF6, 0x41, 0x15, 0x72, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xDF, 0xD5, 0xFE,
    0xD6, 0x3E, 0xDE, 0x7E, 0xE6, 0xDE, 0xEF, 0x3E, 0xEF, 0x5F, 0xEF, 0x5F,
    0xEF, 0x3E, 0xEF, 0x1E, 0xE6, 0xDE, 0xDE, 0x7D, 0xD6, 0x1D, 0xC5, 0x9C,
    0xBD, 0x1B, 0xAC, 0x7B, 0x9B, 0xDA, 0x83, 0x39, 0x72, 0xB8, 0x62, 0x16,
    0x51, 0xB6, 0x38, 0xF5, 0x94, 0x1A, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xDE, 0x3E, 0xD6, 0x1E, 0xDE, 0x3E, 0xE6, 0xDE,
    0xF7, 0x7F, 0xFF, 0xDF, 0xFF, 0xDF, 0xFF, 0xDF, 0xF7, 0x9F, 0xEF, 0x1E,
    0xE6, 0xBE, 0xD6, 0x5D, 0xCD, 0xDD, 0xC5, 0x7C, 0xBC, 0xFB, 0xAC, 0x7B,
    0x9B, 0xFA, 0x8B, 0x59, 0x7A, 0xB8, 0x62, 0x37, 0x51, 0xB6, 0x7B, 0x18,
    0x30, 0xD5, 0xDE, 0xDE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0x5F,
    0xCD, 0xDD, 0xD6, 0x1D, 0xDE, 0x7E, 0xEF, 0x1E, 0xFF, 0xBF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xDF, 0xEF, 0x5F, 0xE6, 0xBE, 0xD6, 0x3D, 0xCD, 0xBD,
    0xC5, 0x5C, 0xBC, 0xFB, 0xB4, 0x9B, 0xA4, 0x3A, 0x93, 0xB9, 0x8B, 0x38,
    0x7A, 0xB8, 0x6A, 0x37, 0x59, 0xD6, 0x51, 0xD6, 0x93, 0xFA, 0x49, 0xB6,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xD6, 0x1E, 0xD5, 0xFD, 0xD6, 0x1D,
    0xDE, 0x9E, 0xEF, 0x5F, 0xFF, 0xBF, 0xFF, 0xFF, 0xFF, 0xDF, 0xF7, 0x7F,
    0xE6, 0xBE, 0xD6, 0x1D, 0xC5, 0x9C, 0xBD, 0x3C, 0xB4, 0xDB, 0xAC, 0x7B,
    0xA4, 0x1A, 0x9B, 0xDA, 0x93, 0x79, 0x83, 0x18, 0x72, 0x97, 0x6A, 0x37,
    0x59, 0xF6, 0x49, 0x95, 0x8B, 0x99, 0x41, 0x15, 0xD6, 0x7D, 0xFF, 0xFF,
    0xF7, 0x9F, 0xCD, 0xDD, 0xD5, 0xFD, 0xD6, 0x3E, 0xEF, 0x1E, 0xFF, 0xBF,
    0xFF, 0xDF, 0xF7, 0xBF, 0xF7, 0x5F, 0xE6, 0xBE, 0xD6, 0x1D, 0xC5, 0x7C,
    0xBD, 0x1C, 0xB4, 0xBB, 0xAC, 0x7B, 0xA4, 0x1A, 0x9B, 0xDA, 0x93, 0x99,
    0x8B, 0x38, 0x82, 0xD8, 0x72, 0x97, 0x6A, 0x57, 0x62, 0x16, 0x59, 0xD6,
    0x62, 0x36, 0x6A, 0x77, 0x7B, 0x58, 0xFF, 0xFF, 0xD6, 0x9D, 0xCD, 0xDD,
    0xCD, 0xDD, 0xD6, 0x1D, 0xE6, 0xDE, 0xFF, 0xDF, 0xFF, 0xFF, 0xEF, 0x3E,
    0xDE, 0x9E, 0xCD, 0xFD, 0xBD, 0x5C, 0xB5, 0x1C, 0xB4, 0xBB, 0xAC, 0x7B,
    0xA4, 0x3A, 0xA3, 0xFA, 0x9B, 0xB9, 0x93, 0x79, 0x8B, 0x18, 0x7A, 0xD8,
    0x72, 0x97, 0x6A, 0x57, 0x62, 0x36, 0x59, 0xF6, 0x51, 0xB6, 0x72, 0xD7,
    0x39, 0x15, 0xFF, 0xFF, 0xCE, 0x3D, 0xCD, 0xDD, 0xCD, 0xDD, 0xCD, 0xBD,
    0xCD, 0xDD, 0xD5, 0xFD, 0xDE, 0x7D, 0xD6, 0x5D, 0xCD, 0xBD, 0xBD, 0x5C,
    0xB4, 0xFC, 0xB4, 0xDB, 0xAC, 0x9B, 0xAC, 0x5A, 0xA4, 0x3A, 0x9B, 0xFA,
    0x9B, 0xB9, 0x93, 0x79, 0x8B, 0x18, 0x82, 0xD8, 0x7A, 0x97, 0x72, 0x77,
    0x6A, 0x37, 0x62, 0x16, 0x59, 0xD6, 0x6A, 0x97, 0x30, 0xB4, 0xF7, 0x9F,
    0xD6, 0x5D, 0xCD, 0xBD, 0xCD, 0xBD, 0xCD, 0xBD, 0xCD, 0xBD, 0xC5, 0xBD,
    0xC5, 0x9C, 0xBD, 0x5C, 0xBD, 0x3C, 0xB5, 0x1C, 0xB4, 0xFB, 0xAC, 0xBB,
    0xAC, 0x9B, 0xAC, 0x7A, 0xA4, 0x3A, 0xA4, 0x1A, 0x9B, 0xD9, 0x93, 0x99,
    0x8B, 0x58, 0x82, 0xF8, 0x7A, 0xB7, 0x72, 0x77, 0x6A, 0x57, 0x62, 0x16,
    0x59, 0xF6, 0x62, 0x36, 0x38, 0xD4, 0xD6, 0x9D, 0xD6, 0x9D, 0xCD, 0x9D,
    0xC5, 0x9D, 0xC5, 0xBD, 0xCD, 0xDD, 0xCD, 0xDD, 0xCD, 0xDC, 0xC5, 0x9C,
    0xBD, 0x1C, 0xB4, 0xFB, 0xB4, 0xBB, 0xAC, 0x9B, 0xAC, 0x7B, 0xAC, 0x7A,
    0xA4, 0x5A, 0xA4, 0x3A, 0x9B, 0xF9, 0x9B, 0xB9, 0x93, 0x78, 0x83, 0x18,
    0x7A, 0xD7, 0x72, 0x97, 0x6A, 0x57, 0x6A, 0x36, 0x61, 0xF6, 0x59, 0xF6,
    0x38, 0xF4, 0xCE, 0x3D, 0xCE, 0x3D, 0xC5, 0x7D, 0xC5, 0x7D, 0xCD, 0xDD,
    0xCD, 0xDD, 0xC5, 0xBC, 0xC5, 0xBC, 0xC5, 0x7C, 0xB5, 0x1C, 0xB4, 0xDB,
    0xAC, 0x9B, 0xAC, 0x7B, 0xAC, 0x5A, 0xA4, 0x5A, 0xA4, 0x5A, 0xA4, 0x39,
    0xA3, 0xF9, 0x9B, 0xD9, 0x93, 0x98, 0x8B, 0x38, 0x7A, 0xD7, 0x72, 0x97,
    0x72, 0x77, 0x6A, 0x36, 0x62, 0x16, 0x59, 0xD6, 0x38, 0xF4, 0xD6, 0x5D,
    0xD6, 0x5D, 0xC5, 0x5C, 0xC5, 0x7D, 0xEF, 0x1E, 0xE6, 0xDE, 0xC5, 0x7C,
    0xBD, 0x7C, 0xBD, 0x3C, 0xB4, 0xFB, 0xAC, 0x9B, 0xAC, 0x7B, 0xAC, 0x5A,
    0xA4, 0x3A, 0xA4, 0x3A, 0xA4, 0x3A, 0xA4, 0x19, 0x9B, 0xF9, 0x9B, 0xD9,
    0x93, 0x98, 0x8B, 0x38, 0x7A, 0xD7, 0x72, 0x97, 0x72, 0x77, 0x6A, 0x37,
    0x62, 0x16, 0x59, 0xD6, 0x38, 0xD4, 0xE7, 0x1E, 0xE7, 0x1E, 0xBD, 0x1C,
    0xBD, 0x5C, 0xF7, 0x7F, 0xF7, 0x7F, 0xBD, 0x5C, 0xB5, 0x1B, 0xB4, 0xDB,
    0xAC, 0x9B, 0xAC, 0x7B, 0xAC, 0x5A, 0xA4, 0x3A, 0xA4, 0x1A, 0xA4, 0x1A,
    0xA4, 0x19, 0x9B, 0xF9, 0x9B, 0xD9, 0x9B, 0xB9, 0x8B, 0x78, 0x83, 0x18,
    0x7A, 0xB7, 0x72, 0x97, 0x72, 0x77, 0x6A, 0x37, 0x62, 0x16, 0x59, 0xB6,
    0x38, 0xD4, 0xFF, 0xFF, 0xFF, 0xFF, 0xB4, 0xDC, 0xB5, 0x1C, 0xDE, 0xBE,
    0xF7, 0x9F, 0xBD, 0x5C, 0xAC, 0xBB, 0xAC, 0x9B, 0xAC, 0x7B, 0xA4, 0x3A,
    0xA4, 0x1A, 0xA3, 0xFA, 0x9B, 0xDA, 0x9B, 0xD9, 0x9B, 0xD9, 0x9B, 0xD9,
    0x9B, 0xB9, 0x93, 0x78, 0x8B, 0x38, 0x82, 0xF7, 0x7A, 0xB7, 0x72, 0x97,
    0x72, 0x77, 0x6A, 0x36, 0x61, 0xF6, 0x49, 0x75, 0x62, 0x56, 0xFF, 0xFF,
    0xFF, 0xFF, 0xAC, 0xBB, 0xB4, 0xDB, 0xC5, 0x9C, 0xEF, 0x3E, 0xCD, 0xDC,
    0xAC, 0x7B, 0xA4, 0x5A, 0xA4, 0x3A, 0xA3, 0xFA, 0x9B, 0xDA, 0x9B, 0xB9,
    0x93, 0x99, 0x93, 0x99, 0x93, 0x99, 0x93, 0x98, 0x8B, 0x78, 0x8B, 0x38,
    0x82, 0xF7, 0x7A, 0xB7, 0x72, 0x97, 0x72, 0x77, 0x6A, 0x57, 0x62, 0x36,
    0x59, 0xF6, 0x41, 0x14, 0xAD, 0x3B, 0xFF, 0xFF, 0xFF, 0xFF, 0xCD, 0xFD,
    0xA4, 0x7B, 0xAC, 0xBB, 0xCD, 0xFD, 0xD6, 0x3D, 0xAC, 0xBB, 0xA4, 0x1A,
    0x9B, 0xFA, 0x9B, 0xB9, 0x9B, 0x99, 0x93, 0x79, 0x8B, 0x59, 0x8B, 0x58,
    0x8B, 0x58, 0x8B, 0x38, 0x83, 0x18, 0x82, 0xF7, 0x7A, 0xB7, 0x72, 0x97,
    0x72, 0x77, 0x6A, 0x56, 0x6A, 0x36, 0x61, 0xF6, 0x51, 0xB5, 0x38, 0xD3,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x9B, 0xFA, 0xA4, 0x3A,
    0xAC, 0x9B, 0xC5, 0x9C, 0xBD, 0x1B, 0xA4, 0x1A, 0x93, 0x99, 0x93, 0x79,
    0x8B, 0x59, 0x8B, 0x58, 0x8B, 0x38, 0x83, 0x18, 0x82, 0xF8, 0x7A, 0xD7,
    0x7A, 0xB7, 0x7A, 0x97, 0x72, 0x97, 0x72, 0x77, 0x6A, 0x56, 0x6A, 0x36,
    0x62, 0x16, 0x59, 0xD5, 0x38, 0xF4, 0xA4, 0xBA, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xD6, 0x5D, 0x93, 0x79, 0x9B, 0xB9, 0xA4, 0x1A,
    0xAC, 0x9B, 0x9C, 0x1A, 0x8B, 0x79, 0x8B, 0x38, 0x83, 0x18, 0x82, 0xF8,
    0x7A, 0xD8, 0x7A, 0xD7, 0x7A, 0xB7, 0x72, 0x97, 0x72, 0x97, 0x72, 0x76,
    0x6A, 0x56, 0x6A, 0x36, 0x62, 0x36, 0x62, 0x16, 0x59, 0xD5, 0x49, 0x54,
    0x49, 0xB4, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xAC, 0xBB, 0x82, 0xF8, 0x8B, 0x38, 0x8B, 0x79, 0x8B, 0x79,
    0x83, 0x18, 0x7A, 0xF8, 0x7A, 0xD7, 0x72, 0xB7, 0x72, 0x97, 0x72, 0x97,
    0x72, 0x76, 0x6A, 0x56, 0x6A, 0x56, 0x62, 0x36, 0x62, 0x16, 0x62, 0x15,
    0x59, 0xF5, 0x59, 0xD5, 0x49, 0x74, 0x30, 0xD3, 0xFF, 0xDF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x9C, 0x3A, 0x6A, 0x77, 0x72, 0xB7, 0x72, 0xB7, 0x72, 0xB7, 0x72, 0x97,
    0x6A, 0x76, 0x6A, 0x76, 0x6A, 0x56, 0x62, 0x36, 0x62, 0x36, 0x62, 0x15,
    0x62, 0x15, 0x59, 0xF5, 0x59, 0xD5, 0x59, 0xD5, 0x51, 0xB4, 0x41, 0x53,
    0x30, 0xD2, 0xEF, 0x5E, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xAC, 0xFB,
    0x59, 0xD5, 0x62, 0x35, 0x62, 0x35, 0x62, 0x35, 0x62, 0x35, 0x5A, 0x15,
    0x5A, 0x15, 0x59, 0xF5, 0x59, 0xD4, 0x51, 0xD4, 0x51, 0xB4, 0x51, 0xB4,
    0x51, 0x94, 0x49, 0x73, 0x30, 0xD2, 0x49, 0x93, 0xFF, 0xDF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0x1E, 0x6A, 0xB6,
    0x41, 0x54, 0x49, 0x94, 0x51, 0xB4, 0x51, 0xB4, 0x51, 0xB4, 0x49, 0x93,
    0x49, 0x93, 0x49, 0x73, 0x41, 0x52, 0x41, 0x32, 0x30, 0xD1, 0x28, 0xB1,
    0x9C, 0xB9, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xDE, 0xBD, 0x83, 0xB7,
    0x41, 0x53, 0x30, 0xD1, 0x28, 0xB0, 0x28, 0xB0, 0x28, 0x90, 0x28, 0x8F,
    0x28, 0x8F, 0x52, 0x33, 0xAD, 0x19, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF7, 0x9E,
    0xD6, 0x9C, 0xCE, 0x1B, 0xCE, 0x5B, 0xE7, 0x1D, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF
};

int16_t accel_x = 0;
int16_t accel_y = 0;

void app_update_mpu6050_data(int16_t *data)
{
    accel_x = data[MPU6050_ACCEL_X];
    accel_y = data[MPU6050_ACCEL_Y];
}

void app_init(void)
{

}

void ILI9341_DrawFilledRect(uint16_t x, uint16_t y, uint16_t w, uint16_t h, uint16_t color)
{
    ILI9341_SetAddress(x, y, x + w - 1, y + h - 1);

    uint32_t total_pixels = w * h;
    uint8_t buffer[400];
    uint8_t hi = color >> 8;
    uint8_t lo = color & 0xFF;

    for (int i = 0; i < sizeof(buffer); i += 2) {
        buffer[i] = hi;
        buffer[i + 1] = lo;
    }

    DC_HIGH();
    while (total_pixels > 0) {
        uint16_t batch = (total_pixels > 200) ? 200 : total_pixels;
        HAL_SPI_Transmit(buffer, batch * 2);
        total_pixels -= batch;
    }
}

void app_draw_ball_diff_update(int old_x, int old_y, int new_x, int new_y)
{
    int ball_size = 28;

    // 畫新位置的小球
    ILI9341_DrawImage_At_Scaled_Fast(myball3d_image, ball_size, ball_size, new_x, new_y, 1);

    // 左側清除（向右移動）
    if (new_x > old_x) {
        int clear_width = new_x - old_x;
        ILI9341_DrawFilledRect(old_x, old_y, clear_width, ball_size, WHITE);
    }

    // 右側清除（向左移動）
    else if (new_x < old_x) {
        int clear_width = old_x - new_x;
        ILI9341_DrawFilledRect(new_x + ball_size, old_y, clear_width, ball_size, WHITE);
    }

    // 上方清除（向下移動）
    if (new_y > old_y) {
        int clear_height = new_y - old_y;
        ILI9341_DrawFilledRect(new_x, old_y, ball_size, clear_height, WHITE);
    }

    // 下方清除（向上移動）
    else if (new_y < old_y) {
        int clear_height = old_y - new_y;
        ILI9341_DrawFilledRect(new_x, new_y + ball_size, ball_size, clear_height, WHITE);
    }
}
#include <stdlib.h> // for abs()
typedef struct {
    int x, y;
    int vx, vy;
} Ball;

static Ball ball1 = {160, 120, 2, 2};
static Ball ball2 = {100, 80, -2, 2};
static Ball ball3 = {50, 50, 2, -2};

#define MIN_SPEED 1
void app_process(void)
{
    static uint32_t timer = 0;
    static uint32_t debug_timer = 0;

    uint32_t now = HAL_GetTick();
    if (now - timer >= 5) {
        timer = now;

        // 更新兩球位置
        #define BALL_COUNT 3
        Ball* balls[BALL_COUNT] = { &ball1, &ball2, &ball3};
        static int prev_x[BALL_COUNT] = {0}, prev_y[BALL_COUNT] = {0};

        // 更新位置與邊界反彈
        for (int i = 0; i < BALL_COUNT; i++) {
            Ball* b = balls[i];
            b->x += b->vx;
            b->y += b->vy;
            // 碰牆反彈 & 修正邊界
            if (b->x <= 0) {
                b->x = 0;
                b->vx = abs(b->vx);  // 保證向右
            } else if (b->x >= 320 - 28) {
                b->x = 320 - 28;
                b->vx = -abs(b->vx); // 保證向左
            }

            if (b->y <= 0) {
                b->y = 0;
                b->vy = abs(b->vy);  // 保證向下
            } else if (b->y >= 240 - 28) {
                b->y = 240 - 28;
                b->vy = -abs(b->vy); // 保證向上
            }
        }

        // 球與球之間碰撞
        for (int i = 0; i < BALL_COUNT; i++) {
            for (int j = i + 1; j < BALL_COUNT; j++) {
                if (abs(balls[i]->x - balls[j]->x) < 28 &&
                    abs(balls[i]->y - balls[j]->y) < 28) {

                    balls[i]->vx = -balls[i]->vx;
                    balls[i]->vy = -balls[i]->vy;
                    balls[j]->vx = -balls[j]->vx;
                    balls[j]->vy = -balls[j]->vy;

                    // 確保反彈後速度不為 0
                    if (abs(balls[i]->vx) < MIN_SPEED) balls[i]->vx = (rand() % 2) ? MIN_SPEED : -MIN_SPEED;
                    if (abs(balls[i]->vy) < MIN_SPEED) balls[i]->vy = (rand() % 2) ? MIN_SPEED : -MIN_SPEED;
                    if (abs(balls[j]->vx) < MIN_SPEED) balls[j]->vx = (rand() % 2) ? MIN_SPEED : -MIN_SPEED;
                    if (abs(balls[j]->vy) < MIN_SPEED) balls[j]->vy = (rand() % 2) ? MIN_SPEED : -MIN_SPEED;
                }
            }
        }

        // 畫面更新
        for (int i = 0; i < BALL_COUNT; i++) {
            app_draw_ball_diff_update(prev_x[i], prev_y[i], balls[i]->x, balls[i]->y);
            prev_x[i] = balls[i]->x;
            prev_y[i] = balls[i]->y;
        }
    }

//    if (now - debug_timer >= 1000) {
//        debug_timer = now;
//        printf("Ball1 (%d, %d) vx=%d vy=%d | Ball3 (%d, %d) vx=%d vy=%d| Ball2 (%d, %d) vx=%d vy=%d| Ball4 (%d, %d) vx=%d vy=%d\n" ,
//               ball1.x, ball1.y, ball1.vx, ball1.vy,
//               ball2.x, ball2.y, ball2.vx, ball2.vy,
//               ball3.x, ball3.y, ball3.vx, ball3.vy,
//               ball4.x, ball4.y, ball4.vx, ball4.vy);
//    }
}

