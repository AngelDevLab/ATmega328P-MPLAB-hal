#include "app.h"
#include "MPU6050.h"
#include "ILI9341.h"
#include <avr/pgmspace.h>
#include "decoder.h"
#include "app_button.h"

static game_status_t game_status = GAME_IDLE;

const uint8_t my_ball_image[1568] PROGMEM = {
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF7, 0x9F, 0xDE, 0x7E, 0xCD, 0xBD,
    0xB4, 0xFC, 0xAC, 0x7C, 0xAC, 0x3B, 0xAC, 0x5B, 0xBD, 0x1C, 0xD6, 0x5D,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0x1F,
    0xCD, 0xBD, 0xBD, 0x3D, 0xBD, 0x1C, 0xBD, 0x1C, 0xB4, 0xDC, 0xB4, 0x9B,
    0xAC, 0x5B, 0x9B, 0xDA, 0x93, 0x5A, 0x7A, 0xB9, 0x6A, 0x38, 0xA4, 0x5B,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xDF, 0xD6, 0x1D, 0xCD, 0x9D, 0xCD, 0xBD, 0xCD, 0x9D,
    0xC5, 0x9D, 0xC5, 0x7D, 0xBD, 0x5C, 0xBC, 0xFC, 0xB4, 0xBB, 0xAC, 0x5B,
    0x9B, 0xDA, 0x93, 0x79, 0x7A, 0xD9, 0x62, 0x17, 0x49, 0x76, 0xB5, 0x5C,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF7, 0x7F, 0xCD, 0xDD,
    0xD5, 0xFD, 0xD5, 0xFD, 0xD5, 0xFD, 0xD6, 0x1D, 0xD5, 0xFD, 0xCD, 0xFD,
    0xCD, 0xDD, 0xC5, 0x9C, 0xBD, 0x3C, 0xB4, 0xDB, 0xAC, 0x5B, 0x9B, 0xBA,
    0x8B, 0x39, 0x72, 0xB8, 0x62, 0x17, 0x41, 0x16, 0x7B, 0x59, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xF7, 0x7F, 0xD5, 0xDD, 0xD6, 0x1E, 0xDE, 0x5E, 0xDE, 0x7E,
    0xDE, 0x9E, 0xE6, 0x9E, 0xDE, 0x9E, 0xDE, 0x7E, 0xDE, 0x5D, 0xD6, 0x1D,
    0xCD, 0xBD, 0xC5, 0x5C, 0xB4, 0xBB, 0xA4, 0x3A, 0x93, 0x99, 0x82, 0xF8,
    0x6A, 0x77, 0x59, 0xF6, 0x41, 0x15, 0x72, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xDF, 0xD5, 0xFE,
    0xD6, 0x3E, 0xDE, 0x7E, 0xE6, 0xDE, 0xEF, 0x3E, 0xEF, 0x5F, 0xEF, 0x5F,
    0xEF, 0x3E, 0xEF, 0x1E, 0xE6, 0xDE, 0xDE, 0x7D, 0xD6, 0x1D, 0xC5, 0x9C,
    0xBD, 0x1B, 0xAC, 0x7B, 0x9B, 0xDA, 0x83, 0x39, 0x72, 0xB8, 0x62, 0x16,
    0x51, 0xB6, 0x38, 0xF5, 0x94, 0x1A, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xDE, 0x3E, 0xD6, 0x1E, 0xDE, 0x3E, 0xE6, 0xDE,
    0xF7, 0x7F, 0xFF, 0xDF, 0xFF, 0xDF, 0xFF, 0xDF, 0xF7, 0x9F, 0xEF, 0x1E,
    0xE6, 0xBE, 0xD6, 0x5D, 0xCD, 0xDD, 0xC5, 0x7C, 0xBC, 0xFB, 0xAC, 0x7B,
    0x9B, 0xFA, 0x8B, 0x59, 0x7A, 0xB8, 0x62, 0x37, 0x51, 0xB6, 0x7B, 0x18,
    0x30, 0xD5, 0xDE, 0xDE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0x5F,
    0xCD, 0xDD, 0xD6, 0x1D, 0xDE, 0x7E, 0xEF, 0x1E, 0xFF, 0xBF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xDF, 0xEF, 0x5F, 0xE6, 0xBE, 0xD6, 0x3D, 0xCD, 0xBD,
    0xC5, 0x5C, 0xBC, 0xFB, 0xB4, 0x9B, 0xA4, 0x3A, 0x93, 0xB9, 0x8B, 0x38,
    0x7A, 0xB8, 0x6A, 0x37, 0x59, 0xD6, 0x51, 0xD6, 0x93, 0xFA, 0x49, 0xB6,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xD6, 0x1E, 0xD5, 0xFD, 0xD6, 0x1D,
    0xDE, 0x9E, 0xEF, 0x5F, 0xFF, 0xBF, 0xFF, 0xFF, 0xFF, 0xDF, 0xF7, 0x7F,
    0xE6, 0xBE, 0xD6, 0x1D, 0xC5, 0x9C, 0xBD, 0x3C, 0xB4, 0xDB, 0xAC, 0x7B,
    0xA4, 0x1A, 0x9B, 0xDA, 0x93, 0x79, 0x83, 0x18, 0x72, 0x97, 0x6A, 0x37,
    0x59, 0xF6, 0x49, 0x95, 0x8B, 0x99, 0x41, 0x15, 0xD6, 0x7D, 0xFF, 0xFF,
    0xF7, 0x9F, 0xCD, 0xDD, 0xD5, 0xFD, 0xD6, 0x3E, 0xEF, 0x1E, 0xFF, 0xBF,
    0xFF, 0xDF, 0xF7, 0xBF, 0xF7, 0x5F, 0xE6, 0xBE, 0xD6, 0x1D, 0xC5, 0x7C,
    0xBD, 0x1C, 0xB4, 0xBB, 0xAC, 0x7B, 0xA4, 0x1A, 0x9B, 0xDA, 0x93, 0x99,
    0x8B, 0x38, 0x82, 0xD8, 0x72, 0x97, 0x6A, 0x57, 0x62, 0x16, 0x59, 0xD6,
    0x62, 0x36, 0x6A, 0x77, 0x7B, 0x58, 0xFF, 0xFF, 0xD6, 0x9D, 0xCD, 0xDD,
    0xCD, 0xDD, 0xD6, 0x1D, 0xE6, 0xDE, 0xFF, 0xDF, 0xFF, 0xFF, 0xEF, 0x3E,
    0xDE, 0x9E, 0xCD, 0xFD, 0xBD, 0x5C, 0xB5, 0x1C, 0xB4, 0xBB, 0xAC, 0x7B,
    0xA4, 0x3A, 0xA3, 0xFA, 0x9B, 0xB9, 0x93, 0x79, 0x8B, 0x18, 0x7A, 0xD8,
    0x72, 0x97, 0x6A, 0x57, 0x62, 0x36, 0x59, 0xF6, 0x51, 0xB6, 0x72, 0xD7,
    0x39, 0x15, 0xFF, 0xFF, 0xCE, 0x3D, 0xCD, 0xDD, 0xCD, 0xDD, 0xCD, 0xBD,
    0xCD, 0xDD, 0xD5, 0xFD, 0xDE, 0x7D, 0xD6, 0x5D, 0xCD, 0xBD, 0xBD, 0x5C,
    0xB4, 0xFC, 0xB4, 0xDB, 0xAC, 0x9B, 0xAC, 0x5A, 0xA4, 0x3A, 0x9B, 0xFA,
    0x9B, 0xB9, 0x93, 0x79, 0x8B, 0x18, 0x82, 0xD8, 0x7A, 0x97, 0x72, 0x77,
    0x6A, 0x37, 0x62, 0x16, 0x59, 0xD6, 0x6A, 0x97, 0x30, 0xB4, 0xF7, 0x9F,
    0xD6, 0x5D, 0xCD, 0xBD, 0xCD, 0xBD, 0xCD, 0xBD, 0xCD, 0xBD, 0xC5, 0xBD,
    0xC5, 0x9C, 0xBD, 0x5C, 0xBD, 0x3C, 0xB5, 0x1C, 0xB4, 0xFB, 0xAC, 0xBB,
    0xAC, 0x9B, 0xAC, 0x7A, 0xA4, 0x3A, 0xA4, 0x1A, 0x9B, 0xD9, 0x93, 0x99,
    0x8B, 0x58, 0x82, 0xF8, 0x7A, 0xB7, 0x72, 0x77, 0x6A, 0x57, 0x62, 0x16,
    0x59, 0xF6, 0x62, 0x36, 0x38, 0xD4, 0xD6, 0x9D, 0xD6, 0x9D, 0xCD, 0x9D,
    0xC5, 0x9D, 0xC5, 0xBD, 0xCD, 0xDD, 0xCD, 0xDD, 0xCD, 0xDC, 0xC5, 0x9C,
    0xBD, 0x1C, 0xB4, 0xFB, 0xB4, 0xBB, 0xAC, 0x9B, 0xAC, 0x7B, 0xAC, 0x7A,
    0xA4, 0x5A, 0xA4, 0x3A, 0x9B, 0xF9, 0x9B, 0xB9, 0x93, 0x78, 0x83, 0x18,
    0x7A, 0xD7, 0x72, 0x97, 0x6A, 0x57, 0x6A, 0x36, 0x61, 0xF6, 0x59, 0xF6,
    0x38, 0xF4, 0xCE, 0x3D, 0xCE, 0x3D, 0xC5, 0x7D, 0xC5, 0x7D, 0xCD, 0xDD,
    0xCD, 0xDD, 0xC5, 0xBC, 0xC5, 0xBC, 0xC5, 0x7C, 0xB5, 0x1C, 0xB4, 0xDB,
    0xAC, 0x9B, 0xAC, 0x7B, 0xAC, 0x5A, 0xA4, 0x5A, 0xA4, 0x5A, 0xA4, 0x39,
    0xA3, 0xF9, 0x9B, 0xD9, 0x93, 0x98, 0x8B, 0x38, 0x7A, 0xD7, 0x72, 0x97,
    0x72, 0x77, 0x6A, 0x36, 0x62, 0x16, 0x59, 0xD6, 0x38, 0xF4, 0xD6, 0x5D,
    0xD6, 0x5D, 0xC5, 0x5C, 0xC5, 0x7D, 0xEF, 0x1E, 0xE6, 0xDE, 0xC5, 0x7C,
    0xBD, 0x7C, 0xBD, 0x3C, 0xB4, 0xFB, 0xAC, 0x9B, 0xAC, 0x7B, 0xAC, 0x5A,
    0xA4, 0x3A, 0xA4, 0x3A, 0xA4, 0x3A, 0xA4, 0x19, 0x9B, 0xF9, 0x9B, 0xD9,
    0x93, 0x98, 0x8B, 0x38, 0x7A, 0xD7, 0x72, 0x97, 0x72, 0x77, 0x6A, 0x37,
    0x62, 0x16, 0x59, 0xD6, 0x38, 0xD4, 0xE7, 0x1E, 0xE7, 0x1E, 0xBD, 0x1C,
    0xBD, 0x5C, 0xF7, 0x7F, 0xF7, 0x7F, 0xBD, 0x5C, 0xB5, 0x1B, 0xB4, 0xDB,
    0xAC, 0x9B, 0xAC, 0x7B, 0xAC, 0x5A, 0xA4, 0x3A, 0xA4, 0x1A, 0xA4, 0x1A,
    0xA4, 0x19, 0x9B, 0xF9, 0x9B, 0xD9, 0x9B, 0xB9, 0x8B, 0x78, 0x83, 0x18,
    0x7A, 0xB7, 0x72, 0x97, 0x72, 0x77, 0x6A, 0x37, 0x62, 0x16, 0x59, 0xB6,
    0x38, 0xD4, 0xFF, 0xFF, 0xFF, 0xFF, 0xB4, 0xDC, 0xB5, 0x1C, 0xDE, 0xBE,
    0xF7, 0x9F, 0xBD, 0x5C, 0xAC, 0xBB, 0xAC, 0x9B, 0xAC, 0x7B, 0xA4, 0x3A,
    0xA4, 0x1A, 0xA3, 0xFA, 0x9B, 0xDA, 0x9B, 0xD9, 0x9B, 0xD9, 0x9B, 0xD9,
    0x9B, 0xB9, 0x93, 0x78, 0x8B, 0x38, 0x82, 0xF7, 0x7A, 0xB7, 0x72, 0x97,
    0x72, 0x77, 0x6A, 0x36, 0x61, 0xF6, 0x49, 0x75, 0x62, 0x56, 0xFF, 0xFF,
    0xFF, 0xFF, 0xAC, 0xBB, 0xB4, 0xDB, 0xC5, 0x9C, 0xEF, 0x3E, 0xCD, 0xDC,
    0xAC, 0x7B, 0xA4, 0x5A, 0xA4, 0x3A, 0xA3, 0xFA, 0x9B, 0xDA, 0x9B, 0xB9,
    0x93, 0x99, 0x93, 0x99, 0x93, 0x99, 0x93, 0x98, 0x8B, 0x78, 0x8B, 0x38,
    0x82, 0xF7, 0x7A, 0xB7, 0x72, 0x97, 0x72, 0x77, 0x6A, 0x57, 0x62, 0x36,
    0x59, 0xF6, 0x41, 0x14, 0xAD, 0x3B, 0xFF, 0xFF, 0xFF, 0xFF, 0xCD, 0xFD,
    0xA4, 0x7B, 0xAC, 0xBB, 0xCD, 0xFD, 0xD6, 0x3D, 0xAC, 0xBB, 0xA4, 0x1A,
    0x9B, 0xFA, 0x9B, 0xB9, 0x9B, 0x99, 0x93, 0x79, 0x8B, 0x59, 0x8B, 0x58,
    0x8B, 0x58, 0x8B, 0x38, 0x83, 0x18, 0x82, 0xF7, 0x7A, 0xB7, 0x72, 0x97,
    0x72, 0x77, 0x6A, 0x56, 0x6A, 0x36, 0x61, 0xF6, 0x51, 0xB5, 0x38, 0xD3,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x9B, 0xFA, 0xA4, 0x3A,
    0xAC, 0x9B, 0xC5, 0x9C, 0xBD, 0x1B, 0xA4, 0x1A, 0x93, 0x99, 0x93, 0x79,
    0x8B, 0x59, 0x8B, 0x58, 0x8B, 0x38, 0x83, 0x18, 0x82, 0xF8, 0x7A, 0xD7,
    0x7A, 0xB7, 0x7A, 0x97, 0x72, 0x97, 0x72, 0x77, 0x6A, 0x56, 0x6A, 0x36,
    0x62, 0x16, 0x59, 0xD5, 0x38, 0xF4, 0xA4, 0xBA, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xD6, 0x5D, 0x93, 0x79, 0x9B, 0xB9, 0xA4, 0x1A,
    0xAC, 0x9B, 0x9C, 0x1A, 0x8B, 0x79, 0x8B, 0x38, 0x83, 0x18, 0x82, 0xF8,
    0x7A, 0xD8, 0x7A, 0xD7, 0x7A, 0xB7, 0x72, 0x97, 0x72, 0x97, 0x72, 0x76,
    0x6A, 0x56, 0x6A, 0x36, 0x62, 0x36, 0x62, 0x16, 0x59, 0xD5, 0x49, 0x54,
    0x49, 0xB4, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xAC, 0xBB, 0x82, 0xF8, 0x8B, 0x38, 0x8B, 0x79, 0x8B, 0x79,
    0x83, 0x18, 0x7A, 0xF8, 0x7A, 0xD7, 0x72, 0xB7, 0x72, 0x97, 0x72, 0x97,
    0x72, 0x76, 0x6A, 0x56, 0x6A, 0x56, 0x62, 0x36, 0x62, 0x16, 0x62, 0x15,
    0x59, 0xF5, 0x59, 0xD5, 0x49, 0x74, 0x30, 0xD3, 0xFF, 0xDF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x9C, 0x3A, 0x6A, 0x77, 0x72, 0xB7, 0x72, 0xB7, 0x72, 0xB7, 0x72, 0x97,
    0x6A, 0x76, 0x6A, 0x76, 0x6A, 0x56, 0x62, 0x36, 0x62, 0x36, 0x62, 0x15,
    0x62, 0x15, 0x59, 0xF5, 0x59, 0xD5, 0x59, 0xD5, 0x51, 0xB4, 0x41, 0x53,
    0x30, 0xD2, 0xEF, 0x5E, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xAC, 0xFB,
    0x59, 0xD5, 0x62, 0x35, 0x62, 0x35, 0x62, 0x35, 0x62, 0x35, 0x5A, 0x15,
    0x5A, 0x15, 0x59, 0xF5, 0x59, 0xD4, 0x51, 0xD4, 0x51, 0xB4, 0x51, 0xB4,
    0x51, 0x94, 0x49, 0x73, 0x30, 0xD2, 0x49, 0x93, 0xFF, 0xDF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0x1E, 0x6A, 0xB6,
    0x41, 0x54, 0x49, 0x94, 0x51, 0xB4, 0x51, 0xB4, 0x51, 0xB4, 0x49, 0x93,
    0x49, 0x93, 0x49, 0x73, 0x41, 0x52, 0x41, 0x32, 0x30, 0xD1, 0x28, 0xB1,
    0x9C, 0xB9, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xDE, 0xBD, 0x83, 0xB7,
    0x41, 0x53, 0x30, 0xD1, 0x28, 0xB0, 0x28, 0xB0, 0x28, 0x90, 0x28, 0x8F,
    0x28, 0x8F, 0x52, 0x33, 0xAD, 0x19, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF7, 0x9E,
    0xD6, 0x9C, 0xCE, 0x1B, 0xCE, 0x5B, 0xE7, 0x1D, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF
};

static void app_draw_board(game_object_t *self)
{
    ILI9341_DrawFilledRect(self->x, self->y, self->width, self->height, BLACK);
}

static void app_draw_ball(game_object_t *self)
{
    ILI9341_DrawImage_At_Scaled_Fast(my_ball_image, self->width, self->height, self->x, self->y, 1);
}

game_object_t game_board = {
    .width = 60,
    .height = 10,
    .x = 10,
    .y = 200,
    .dx = 0,
    .dy = 0,
    .draw = app_draw_board,
};

game_object_t game_ball = {
    .width = 28,
    .height = 28,
    .x = 24,
    .y = 172,
    .dx = 0,
    .dy = 0,
    .draw = app_draw_ball,
};

void app_update_rect_move_diff(game_object_t *obj, uint16_t bg_color)
{
    obj->draw(obj);
    
    // 左側清除（向右移動）
    if (obj->dx > 0) {
        ILI9341_DrawFilledRect(obj->x - obj->dx, obj->y, obj->dx, obj->height, bg_color);
    }
    // 右側清除（向左移動）
    else if (obj->dx < 0) {
        ILI9341_DrawFilledRect(obj->x + obj->width, obj->y, -obj->dx, obj->height, bg_color);
    }

    // 上方清除（向下移動）
    if (obj->dy > 0) {
        ILI9341_DrawFilledRect(obj->x, obj->y - obj->dy, obj->width, obj->dy, bg_color);
    }
    // 下方清除（向上移動）
    else if (obj->dy < 0) {
        ILI9341_DrawFilledRect(obj->x, obj->y + obj->height, obj->width, -obj->dy, bg_color);
    }
    
    obj->x += obj->dx;
    obj->y += obj->dy;
}

void app_check_collision_and_stop(game_object_t *obj)
{
    // 右邊碰撞
    if (obj->x + obj->width >= ILI9341_WIDTH && obj->dx > 0) {
        obj->x = ILI9341_WIDTH - obj->width;
        obj->dx = 0;
    }
    // 左邊碰撞
    if (obj->x <= 0 && obj->dx < 0) {
        obj->x = 0;
        obj->dx = 0;
    }
    // 下面碰撞
    if (obj->y + obj->height >= ILI9341_HEIGHT && obj->dy > 0) {
        obj->y = ILI9341_HEIGHT - obj->height;
        obj->dy = 0;
    }
    // 上面碰撞
    if (obj->y <= 0 && obj->dy < 0) {
        obj->y = 0;
        obj->dy = 0;
    }
    
    obj->draw(obj);
}

void app_check_collision_and_reflex(game_object_t *obj)
{
    //右牆判斷
    if (obj->dx > 0) {
        if (obj->x + obj->width + obj->dx >= ILI9341_WIDTH) {
            obj->dx = -obj->dx;
            obj->x = ILI9341_WIDTH -obj->width;
        }
    }
    //左牆判斷
    if (obj->dx < 0) {
        if (obj->x  + obj->dx <= 0) {
            obj->dx = -obj->dx;
            obj->x = 0;
        }
    }
    //下牆判斷
    if (obj->dy > 0) {
        if (obj->y + obj->height + obj->dy >= ILI9341_HEIGHT) {
            obj->dy = -obj->dy;
            obj->y = ILI9341_HEIGHT -obj->height;
        }
    }
    //上牆判斷
    if (obj->dy < 0) {
        if (obj->y  + obj->dy <= 0) {
            obj->dy = -obj->dy;
            obj->y = 0;
        }
    }
}

static void app_ili9341_update(void)
{
    static uint32_t last_tick = 0;
    
    if(HAL_GetTick() - last_tick >= 10){
        last_tick = HAL_GetTick();
        
        app_check_collision_and_stop(&game_board);
        app_update_rect_move_diff(&game_board, WHITE);
        
        app_check_collision_and_reflex(&game_ball);
        app_update_rect_move_diff(&game_ball, WHITE);
    }
}

static void app_game_process(void)
{
    int game_ball_center = 0;
    
    switch(game_status)
    {
        case GAME_IDLE:
            break;
        case GAME_START:
            game_status = GAME_PLAYING;
            game_ball.dx = 2;
            game_ball.dy = -2;
            break;
        case GAME_PLAYING:
            if (game_ball.y + game_ball.height + game_ball.dy >= game_board.y) {
                game_ball_center = game_ball.x + game_ball.dx + (game_ball.width /2);
                if ((game_ball_center <= game_board.x) || (game_ball_center >= game_board.x + game_board.width)) {
                    game_status = GAME_FAIL;
                }
                else {
                    game_ball.y = game_board.y - game_ball.height;
                    game_ball.dy = -game_ball.dy;
                    
                    if (game_board.dx == 0) {
                        game_ball.dy = -2;
                    }
                    else {
                        game_ball.dy = -4;
                    }
                }
            }
            
            break;
        case GAME_FAIL:
            game_ball.dx = 0;
            game_ball.dy = 0;
            game_board.dx = 0;
            game_board.dy = 0;
            ILI9341_FillScreen(LIGHTGREY);
            HAL_Delay(1000);
            ILI9341_FillScreen(WHITE);
            game_ball.x = 24;
            game_ball.y = 172;
            game_board.x = 10;
            game_board.y = 200;
            game_status = GAME_IDLE;
            break;
        case GAME_STOP:
            break;
            
    }
}

void app_init(void)
{
    app_button_init(&HAL_GetTick);
    MPU6050_Init(&HAL_GetTick);
    
    ILI9341_Init();
    ILI9341_SetRotation(SCREEN_HORIZONTAL_2);
    ILI9341_FillScreen(WHITE);
    
    game_board.draw(&game_board);
    game_ball.draw(&game_ball);
}

void app_process(void)
{
    MPU6050_Process();
    app_button_process();
    
    app_game_process();
    app_ili9341_update();
}

void decoder_callback(const char* cmd, const char* arg1, const char* arg2)
{
    if (strcmp(cmd, "@UART") == 0) {
        printf("@UART,ok\r\n");
    }
}

void HAL_UART_CommandHandler(const char* cmd)
{
    decoder_input(cmd);
}

void MPU6050_DataCallback(int16_t *data)
{

}

void app_button_event_handler(hal_button_num_t num, app_button_event_t event, uint32_t time_ms)
{
    if (game_status == GAME_IDLE)
        game_status = GAME_START;
    
    if (num == BUTTON_1) {
        if (event == BUTTON_LOW || event == BUTTON_PRESSING) {
            game_board.dx = 10;
        }
        else {
            game_board.dx = 0;
        }
    }
    
    if (num == BUTTON_2) {
        if (event == BUTTON_LOW || event == BUTTON_PRESSING) {
            game_board.dx = -10;
        }
        else {
            game_board.dx = 0;
        }
    }
}
